<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover">
    
    <title>Building a Retail Semantic Layer with Unity Catalog Metric Views</title>
    <meta name="description" content="This article explains how Databricks Unity Catalog Metric Views create a governed semantic layer that transforms complex retail data into consistent, business-ready insights—empowering teams to accelerate knowledge work and make revenue-driving decisions with confidence.">
    <meta name="keywords" content="databricks, retail, lakeflow connect, CTAS, python, data pipeline, ETL, workflow automation">
    <meta name="author" content="Josh Patterson">


    <meta property="og:title" content="Building a Retail Semantic Layer with Unity Catalog Metric Views"/>
    <meta property="og:image" content="https://pattersonconsultingtn.com/assets/img/databricks_semantic_metric_views_header_0.jpg"/>
    <meta property="og:url" content="https://pattersonconsultingtn.com/blog/building_retail_semantic_layer_with_unity_catalog_metric_views.html"/>
    <meta property="og:site_name" content="Patterson Consulting"/>
    <meta property="og:description" content="This article explains how Databricks Unity Catalog Metric Views create a governed semantic layer that transforms complex retail data into consistent, business-ready insights—empowering teams to accelerate knowledge work and make revenue-driving decisions with confidence."/>


    <meta name="twitter:title" content="Building a Retail Semantic Layer with Unity Catalog Metric Views" />
    <meta name="twitter:image" content="https://pattersonconsultingtn.com/assets/img/databricks_semantic_metric_views_header_0.jpg" />
    <meta name="twitter:url" content="https://pattersonconsultingtn.com/blog/building_retail_semantic_layer_with_unity_catalog_metric_views.html" />
    <meta name="twitter:card" content="summary_large_image" />


    <link rel="manifest" href="/alpha_manifest.json">

    
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/app-icons/pct_box_logo_16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/app-icons/pct_box_logo_32x32.png">        
    
    <script src="../assets/js/theme-switcher.js"></script>

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet" id="google-font">


    <link rel="stylesheet" media="screen" href="../assets/vendor/swiper/swiper-bundle.min.css">
    <link rel="stylesheet" media="screen" href="../assets/vendor/lightgallery/css/lightgallery-bundle.min.css">

    <link rel="stylesheet" media="screen" href="../assets/vendor/aos/dist/aos.css">

    <link rel="stylesheet" href="../assets/icons/around-icons.min.css">

    <link rel="stylesheet" media="screen" href="../assets/css/theme.pct.v2.css">

    <link href="../assets/css/prism.css" rel="stylesheet" />


    <style>
      .page-loading {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        -webkit-transition: all .4s .2s ease-in-out;
        transition: all .4s .2s ease-in-out;
        background-color: #fff;
        opacity: 0;
        visibility: hidden;
        z-index: 9999;
      }
      [data-bs-theme="dark"] .page-loading {
        background-color: #121519;
      }
      .page-loading.active {
        opacity: 1;
        visibility: visible;
      }
      .page-loading-inner {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        text-align: center;
        -webkit-transform: translateY(-50%);
        transform: translateY(-50%);
        -webkit-transition: opacity .2s ease-in-out;
        transition: opacity .2s ease-in-out;
        opacity: 0;
      }
      .page-loading.active > .page-loading-inner {
        opacity: 1;
      }
      .page-loading-inner > span {
        display: block;
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        font-weight: normal;
        color: #6f788b;
      }
      [data-bs-theme="dark"] .page-loading-inner > span {
        color: #fff;
        opacity: .6;
      }
      .page-spinner {
        display: inline-block;
        width: 2.75rem;
        height: 2.75rem;
        margin-bottom: .75rem;
        vertical-align: text-bottom;
        background-color: #d7dde2; 
        border-radius: 50%;
        opacity: 0;
        -webkit-animation: spinner .75s linear infinite;
        animation: spinner .75s linear infinite;
      }
      [data-bs-theme="dark"] .page-spinner {
        background-color: rgba(255,255,255,.25);
      }
      @-webkit-keyframes spinner {
        0% {
          -webkit-transform: scale(0);
          transform: scale(0);
        }
        50% {
          opacity: 1;
          -webkit-transform: none;
          transform: none;
        }
      }
      @keyframes spinner {
        0% {
          -webkit-transform: scale(0);
          transform: scale(0);
        }
        50% {
          opacity: 1;
          -webkit-transform: none;
          transform: none;
        }
      }

      .todo_edit { 
        color: #ff0000;
       }
    </style>

    <script>
      (function () {
        window.onload = function () {
          const preloader = document.querySelector('.page-loading')
          preloader.classList.remove('active')
          setTimeout(function () {
            preloader.remove()
          }, 1500)

          const theme = 'light'
          document.documentElement.setAttribute('data-bs-theme', theme)
          

        }
      })()
    </script>

    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-N6H6PTM9');</script>
    </head>


  <body>


    <div class="page-loading active">
      <div class="page-loading-inner">
        <div class="page-spinner"></div>
        <span>Loading...</span>
      </div>
    </div>


    <main class="page-wrapper">

      <header data-bs-theme="light">
        <div class="navbar navbar-expand-lg fixed-top bg-light">
          <div class="container">

            <a class="navbar-brand pe-sm-3" href="../../index.html">
              <span class="text-primary flex-shrink-0 me-2">
                <svg width="35" height="32" viewBox="0 0 36 33" xmlns="http://www.w3.org/2000/svg">
                  <g transform="matrix(0.004459, 0, 0, -0.00433, -8154.369629, -2022.807495)" fill="#000000" stroke="none" style="transform-origin: 8189.37px 2055.78px;">
  <path d="M340 9410 l0 -260 1348 0 c807 0 1370 -4 1403 -9 30 -6 101 -15 159
-21 177 -19 447 -88 605 -155 242 -103 389 -186 553 -310 124 -94 287 -257
390 -390 26 -34 100 -148 140 -215 214 -362 327 -901 282 -1345 -11 -115 -47
-341 -58 -362 -5 -10 -14 -45 -21 -78 -7 -33 -16 -64 -20 -70 -4 -5 -13 -30
-20 -55 -7 -25 -19 -58 -26 -75 -70 -160 -92 -205 -132 -277 -45 -80 -161
-257 -189 -288 -8 -8 -33 -37 -56 -65 -60 -71 -200 -208 -277 -270 -88 -70
-241 -175 -258 -175 -7 0 -13 -3 -13 -8 0 -11 -304 -162 -326 -162 -3 0 -20
-7 -37 -14 -45 -21 -210 -74 -254 -82 -21 -4 -45 -10 -55 -15 -9 -5 -72 -18
-140 -30 -67 -12 -145 -26 -173 -31 -29 -6 -359 -12 -782 -15 l-733 -4 0
-1175 0 -1174 3270 0 3270 0 0 3695 0 3695 -3925 0 -3925 0 0 -260z" style="fill: rgb(255, 149, 0);"></path>
  <path d="M1650 6884 l0 -1096 648 4 647 4 120 28 c66 16 125 32 130 36 6 4 28
13 50 20 53 17 129 56 179 92 23 16 52 36 66 46 86 60 201 201 261 322 84 168
109 281 116 525 7 251 -18 402 -97 580 -56 126 -184 280 -295 355 -27 18 -62
42 -77 52 -15 10 -29 18 -32 18 -3 0 -30 11 -60 25 -30 14 -61 25 -68 25 -7 1
-31 8 -53 16 -101 37 -228 44 -892 44 l-643 0 0 -1096z" style="fill: rgb(255, 149, 0);"></path>
</g>



                </svg>
              </span>
              Patterson Consulting
            </a>


            <a class="btn btn-primary btn-sm fs-sm order-lg-3 d-none d-sm-inline-flex" href="../../contact_us.html" target="_blank" rel="noopener">
              <i class="fs-xl me-2 ms-n1"></i>
              Contact Us
            </a>

            <button class="navbar-toggler ms-sm-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>

            <nav class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav navbar-nav-scroll me-auto" style="--ar-scroll-height: 520px;">


                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">Industries</a>
                  <ul class="dropdown-menu">
                    
                    <li><a class="dropdown-item" href="../retail_industry.html">Retail</a></li>
                    <li><a class="dropdown-item" href="../insurance_industry.html">Insurance</a></li>
                    <li><a class="dropdown-item" href="../municipal_industry.html">Smart City</a></li>

                  </ul>
                </li>


                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">Engineering Services</a>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="../offerings/migrations_to_databricks.html">Migration to Databricks</a></li>
                    <li><a class="dropdown-item" href="../platform_engineering.html">Platform Engineering</a></li>
                    <li><a class="dropdown-item" href="../data_engineering.html">Data Engineering</a></li>
                    <li><a class="dropdown-item" href="../generative_ai.html">GenAI Services</a></li>
                    </ul>

                </li>

                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">Resources</a>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="../blog/blog_index.html">Blog</a></li>
                    <li><a class="dropdown-item" href="../publications.html">Team Publications</a></li>
                    <li><a class="dropdown-item" href="../index.html#case_studies">Case Studies</a></li>
                    <li><a class="dropdown-item" href="https://www.youtube.com/channel/UCmaki2Xq1AeFL8XbWGIWyQg">Videos</a></li>
                  </ul>

                </li>

                <li class="nav-item">
                  <a class="nav-link" href="../about.html">About</a>
                </li>
              </ul>
            </nav>

          </div>
        </div>
      </header>


      <section class="container py-5 mt-5 mb-md-2 mb-lg-3 mb-xl-4">

        <nav aria-label="breadcrumb">
          
          <ol class="pt-lg-3 pb-lg-4 pb-2 breadcrumb">
            <li class="breadcrumb-item"><a href="">Home</a></li>
            <li class="breadcrumb-item"><a href="../">Blog Index</a></li>
            <li class="breadcrumb-item active" aria-current="page">Building a Retail Semantic Layer with Unity Catalog Metric Views</li>
          </ol>
          
        </nav>

        <h1 class="display-4 text-left pb-2 pb-lg-3">Building a Retail Semantic Layer with Unity Catalog Metric Views</h1>

        <div class="d-flex flex-wrap align-items-center justify-content-between border-bottom mb-4">
              <div class="d-flex align-items-center mb-4 me-4">
                <span class="fs-sm me-2">By:</span>
                <a class="nav-link position-relative fw-semibold p-0" href="#author" data-scroll data-scroll-offset="80">
                  Nikhil Karnik
                  <span class="d-block position-absolute start-0 bottom-0 w-100" style="background-color: currentColor; height: 1px;"></span>
                </a>
              </div>

            </div>

      </section>


      <section class="jarallax" data-jarallax data-speed=".65">
        <div class="jarallax-img bg-position-center-y" style="background-image: url(../assets/img/databricks_semantic_metric_views_header_0.jpg);"></div>
        <div class="d-none d-xxl-block" style="height: 500px;"></div>
        <div class="d-none d-xl-block d-xxl-none" style="height: 650px;"></div>
        <div class="d-none d-lg-block d-xl-none" style="height: 500px;"></div>
        <div class="d-none d-md-block d-lg-none" style="height: 400px;"></div>
        <div class="d-md-none" style="height: 300px;"></div>
      </section>


      <section class="container pt-5 mt-md-2 mt-lg-3 mt-xl-4">
        <div class="row justify-content-center pt-xxl-2">
          <div class="col-lg-9 col-xl-8">


<p class="fs-lg">
In today’s retail environment, knowledge work depends on fast, consistent access to trusted information—and that’s exactly what a semantic layer powered by Databricks Unity Catalog Metric Views delivers. By translating complex data models into business-friendly concepts like “Total Sales” or “On-Time In-Full,” Metric Views eliminate the reporting chaos of hundreds of one-off SQL views and ensure every team works from the same, governed definitions of key metrics. 
</p>
<p class="fs-lg">
This architecture abstracts away technical complexity, allowing business leaders and analysts to focus on insights, not data plumbing. Because Metric Views live within Unity Catalog, they inherit fine-grained governance and access control automatically, creating a single, trusted information layer across the enterprise. The result is a self-service analytics environment that accelerates decision-making, improves coordination across merchandising, logistics, and operations, and transforms raw retail data into revenue-driving knowledge work—at scale and without dependency on data engineers for every new question.

</p>


<h2 class="h3 mb-lg-4 pt-3 pt-md-4 pt-xl-5">What is a Semantic Layer?</h2>

<p class="fs-lg">
A semantic layer is a business-friendly translation layer. It sits between complex, raw data tables and the end-users who need to consume that data, such as an analyst using a BI tool. (Learn more at the Databricks Glossary: What is a Semantic Layer?).
</p>

<p class="fs-lg">
Think of it as a "data menu" for a restaurant. The kitchen (your data platform) has complex recipes (<code>fct_sales</code>, <code>dim_customer</code>). The customer just wants to order "Total Sales for the Midwest." The semantic layer is the menu that defines "Total Sales" with a specific recipe, allowing the user to get what they need by name.
</p>

<p class="fs-lg">
As Databricks defines it, a semantic layer "creates a unified business view of data across an organization, regardless of where the data resides or how it’s structured.”
</p>

<p class="fs-lg">
This layer is crucial because it:
</p>

<ul>
  <li>Abstracts Complexity: Hides complex joins and technical table names, presenting users with familiar terms like "Revenue" or "Region."</li>
  <li>Ensures Consistency: Provides a single source of truth. The definition of "Active Users" is defined once, ensuring all departments use the same calculation.</li>
  <li>Enables Self-Service: Empowers business users to build their own reports without needing a data engineer for every new question.</li>
</ul>

<h2 class="h3 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Databricks Metric Views &amp; Unity Catalog</h2>

<p class="fs-lg">
In Databricks, the <code>Metric View</code> is the specific object you create to build your semantic layer. It’s a tangible metadata object where you formally define your key metrics (like "Total Sales") and dimensions (like "Product Category") on top of your Lakehouse tables. (See the documentation: <code>Unity Catalog Metric Views</code>).
</p>

<p class="fs-lg">
This feature is built directly into <code>Unity Catalog</code>, which is the foundation for governance and metadata for your data and AI assets on the Lakehouse. (See the product page: <code>Databricks Unity Catalog</code>).
</p>

<p class="fs-lg">
This integration is the key. Because Metric Views live within Unity Catalog, all your data governance is applied automatically. UC manages the fine-grained access control, so you can decide who is allowed to see sensitive metrics (like "Employee Salaries") or data from specific regions.
</p>

<p class="fs-lg">
In summary: <code>Unity Catalog</code> provides the single, governed foundation, and <code>Metric Views</code> build the unified semantic layer on top of it.
</p>

<h2 class="h3 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Why Are Metric Views So Useful?</h2>

<p class="fs-lg">
The primary value of a Metric View is that it separates the definition of a metric from how an end-user queries it. This solves one of the biggest challenges in analytics: inconsistent logic and report sprawl.
</p>


<p class="fs-lg">
Without a metric view, you'd use a standard SQL <code>VIEW</code>. You might create <code>v_sales_by_quarter</code>. But when the business needs "sales by region," you have to create another view, <code>v_sales_by_region</code>. This grows into hundreds of views, each with slightly different logic, making the data difficult to manage.
</p>


<p class="fs-lg">
Metric Views fix this by letting you define your "building blocks" one time:
</p>

<ul>
  <li>Measure: <code>Total Revenue</code> (defined as <code>SUM(fct_sales.amount)</code>)</li>
  <li>Dimension: <code>Region</code> (from <code>dim_customer.region</code>)</li>
  <li>Dimension: <code>Time</code> (from <code>dim_date.calendar_date</code>)</li>
</ul>

<p class="fs-lg">
Now, a BI tool can ask for any combination. When a user requests "Total Revenue by Region," the system is smart enough to "generate the correct query based on the user’s selection, while preserving consistent, centralized metric logic.”
</p>

<p class="fs-lg">
You define the logic once, and it can answer hundreds of questions.
</p>

<p class="fs-lg">

  A metric view is like the "swiss army knife" of views.

</p>


<h2 class="h5 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Key Benefits</h2>

<ul>
  <li><b>Powers Truly Self-Service Dashboards:</b> A BI tool (like Tableau or Power BI) can connect to a single Metric View and see a clean list of measures and dimensions. An analyst can drag-and-drop "Total Revenue" and "Region" to build a report without writing any SQL.</li>
  <li><b>Creates a "Storefront" for Your Gold Layer:</b> In a Medallion Data Architecture, your Gold tables are your ultimate source of truth. A Metric View is the consumption layer, or "storefront," that sits on top of those tables. It translates your clean data into interactive, easy-to-use assets for the entire organization.</li>
</ul>





<h2 class="h3 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Building a Practical Example: The "OTIF" Metric View</h2>

<p class="fs-lg">
Let's continue building out a data lakehouse for the mythical retail company, "Big Cloud Dealz," running on the <a href="driving_retail_information_architecture_with_databricks_medallion_architecture.html" target="_blank">Medallion Data Architecture we started in the previous article</a>.
</p>

<p class="fs-lg">
The logistics team needs to track a complex KPI: On-Time In-Full (<code>OTIF</code>). This metric requires joining shipment data (was it on time?) with purchase order data (was it in full?) and enriching it with carrier and location details. This is a perfect use case for a <b>metric view</b>.
</p>





<h2 class="h4 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Defining the Metric (The "How")</h2>


<p class="fs-lg">
Let's create a single metric view, <code>big_cloud_dealz_development.gold.metric_view_otif</code>, in YAML. Here's the text YAML definition:
</p>


<pre class="line-numbers mt-5 mb-5">
<code class="language-yaml">
version: 1.1
source: |
  WITH shipments AS (
    SELECT
      s.po_id,
      s.appt_ts,
      s.actual_arrival_ts,
      s.from_location_id,
      s.to_location_id,
      s.service_level,
      s.carrier_id
    FROM big_cloud_dealz_development.silver.fact_shipments s
  ), po_promises AS (
    SELECT
      h.po_id,
      h.promised_arrival_end
    FROM big_cloud_dealz_development.silver.fact_po_header h
  ), merged AS (
    SELECT
      sh.po_id,
      sh.appt_ts,
      CASE
        WHEN sh.actual_arrival_ts IS NOT NULL
         AND pr.promised_arrival_end IS NOT NULL
         AND sh.actual_arrival_ts <= pr.promised_arrival_end
        THEN 1 ELSE 0
      END AS on_time,
      sh.from_location_id,
      sh.to_location_id,
      sh.service_level,
      sh.carrier_id
    FROM shipments sh
    LEFT JOIN po_promises pr
      ON sh.po_id = pr.po_id
  ), po_line_sums AS (
    SELECT po_id, SUM(qty_ordered) AS qty_ordered
    FROM big_cloud_dealz_development.silver.fact_po_line
    GROUP BY po_id
  ), receipt_sums AS (
    SELECT po_id, SUM(received_quantity) AS received_quantity
    FROM big_cloud_dealz_development.silver.fact_shipment_receipts
    GROUP BY po_id
  ), in_full_po AS (
    SELECT
      pl.po_id,
      pl.qty_ordered,
      COALESCE(rc.received_quantity, 0) AS received_quantity,
      CASE WHEN COALESCE(rc.received_quantity, 0) >= pl.qty_ordered THEN 1 ELSE 0 END AS in_full
    FROM po_line_sums pl
    LEFT JOIN receipt_sums rc USING (po_id)
  ) SELECT
    CAST(m.appt_ts AS DATE) AS metric_date,
    m.po_id,
    m.on_time,
    f.in_full,
    CASE WHEN m.on_time = 1 AND f.in_full = 1 THEN 1 ELSE 0 END AS otif_flag,
    m.from_location_id,
    m.to_location_id,
    m.service_level,
    m.carrier_id
  FROM merged m LEFT JOIN in_full_po f
    ON m.po_id = f.po_id
joins:
  - name: from_loc
    source: big_cloud_dealz_development.silver.dim_locations
    "on": from_loc.location_id = source.from_location_id AND from_loc.is_current =
      TRUE
  - name: to_loc
    source: big_cloud_dealz_development.silver.dim_locations
    "on": to_loc.location_id = source.to_location_id AND to_loc.is_current = TRUE
  - name: carriers
    source: big_cloud_dealz_development.silver.dim_carriers
    "on": carriers.carrier_id = CAST(source.carrier_id AS STRING) AND carriers.is_current
      = TRUE
comment: |
  OTIF (On Time In Full) KPI with shipment-level flags, aligned to appointment date. Dimensions include multiple time grains and both origin/destination locations. Source logic mirrors Python compute_otif and the SQL view flags used in gold.view_otif_by_date.
dimensions:
  - name: date
    expr: metric_date
    display_name: Date
    format:
      type: date
      date_format: year_month_day
      leading_zeros: true
    synonyms:
      - day
      - appointment date
      - appt date
  - name: week
    expr: "DATE_TRUNC('week', metric_date)"
    display_name: Week
    synonyms:
      - iso week
      - week start
  - name: month
    expr: "DATE_TRUNC('month', metric_date)"
    display_name: Month
    synonyms:
      - calendar month
      - order month
  - name: quarter
    expr: "DATE_TRUNC('quarter', metric_date)"
    display_name: Quarter
  - name: year
    expr: "DATE_TRUNC('year', metric_date)"
    display_name: Year
  - name: from_location_id
    expr: from_location_id
    display_name: From Location ID
    synonyms:
      - origin id
      - ship-from id
  - name: from_location_name
    expr: from_loc.name
    display_name: From Location
    synonyms:
      - origin
      - ship-from
  - name: from_location_type
    expr: from_loc.location_type
    display_name: From Location Type
    synonyms:
      - origin type
  - name: from_region
    expr: from_loc.region
    display_name: From Region
  - name: from_state
    expr: from_loc.state
    display_name: From State
  - name: to_location_id
    expr: to_location_id
    display_name: To Location ID
    synonyms:
      - destination id
      - ship-to id
  - name: to_location_name
    expr: to_loc.name
    display_name: To Location
    synonyms:
      - destination
      - ship-to
  - name: to_location_type
    expr: to_loc.location_type
    display_name: To Location Type
    synonyms:
      - destination type
  - name: to_region
    expr: to_loc.region
    display_name: To Region
  - name: to_state
    expr: to_loc.state
    display_name: To State
  - name: carrier_id
    expr: carrier_id
    display_name: Carrier ID
  - name: carrier_name
    expr: carriers.carrier_name
    display_name: Carrier
  - name: mode
    expr: carriers.mode
    display_name: Transport Mode
    synonyms:
      - ship mode
      - freight mode
  - name: service_level
    expr: service_level
    display_name: Service Level
    synonyms:
      - svc level
      - promise tier
measures:
  - name: otif_rate
    expr: AVG(otif_flag)
    display_name: OTIF %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - on-time in full
      - otif percent
      - otif rate
  - name: otif_count
    expr: SUM(otif_flag)
    display_name: OTIF Count
    format:
      type: number
      decimal_places:
        type: all
      hide_group_separator: false
    synonyms:
      - count otif
      - num otif
  - name: shipment_rows
    expr: COUNT(1)
    display_name: Shipment Rows
    format:
      type: number
      decimal_places:
        type: all
  - name: on_time_rate
    expr: AVG(on_time)
    display_name: On-time %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - on-time rate
      - punctuality %
  - name: in_full_rate
    expr: AVG(in_full)
    display_name: In-full %
    format:
      type: percentage
      decimal_places:
        type: exact
        places: 2
    synonyms:
      - fill rate
      - in full percent
  - name: po_count
    expr: COUNT(DISTINCT po_id)
    display_name: PO Count (distinct)
    format:
      type: number
      decimal_places:
        type: all
    synonyms:
      - unique pos
      - distinct po
</code>
</pre>


<p class="fs-lg">

  Let's break down the major sections of the yaml definition of the metric view above.

</p>

<h2 class="h4 mb-lg-4 pt-3 pt-md-4 pt-xl-5">source</h2>
<p class="fs-lg">
This section is defined by a SQL query that pulls from Silver-layer tables. It joins <code>fact_shipments</code> with <code>fact_po_header</code> to calculate an <code>on_time</code> flag. It also joins <code>fact_po_line</code> with <code>fact_shipment_receipts</code> to calculate an <code>in_full</code> flag. This is where all the complex business logic lives, hidden from the user.
</p>

<h2 class="h4 mb-lg-4 pt-3 pt-md-4 pt-xl-5">joins</h2>

<p class="fs-lg">
  <!--
This section defines how to link IDs from the source query (like <code>carrier_id</code> or <code>location_id</code>) to the full dimension tables (<code>dim_carriers</code>, <code>dim_locations</code>).
-->

The <code>joins</code> section defines how the core OTIF metric logic connects to related dimension tables—such as locations and carriers—so the metric view can enrich shipment data with descriptive business context. For example, it links each shipment’s origin and destination IDs to <code>dim_locations</code> to retrieve region, state, and location type, and joins carrier IDs to <code>dim_carriers</code> for names and transport modes. These joins ensure that every OTIF record is not just a numerical flag but a fully described business event, enabling users to analyze performance by carrier, route, or region without manually writing complex SQL joins.

</p>

<h2 class="h4 mb-lg-4 pt-3 pt-md-4 pt-xl-5">dimensions</h2>

<p class="fs-lg">
  <!--
This lists all the "slice and dice" fields for the user, like <code>date</code>, <code>week</code>, <code>month</code>, <code>carrier_name</code>, <code>from_region</code>, and <code>to_region</code>. We can even add synonyms, so a user asking for "origin" gets the <code>from_location_name</code> column.
-->
The <code>dimensions</code> section defines the contextual attributes—such as date, week, month, locations, carrier, and service level—that allow the OTIF metric to be sliced, filtered, and analyzed across different business perspectives. Each dimension maps to a specific column or derived expression in the underlying data (for example, <code>DATE_TRUNC('month', metric_date)</code> for month-level rollups), and includes user-friendly display names and synonyms so that AI/BI tools and conversational interfaces like Genie can understand natural language queries (“show OTIF by carrier” or “OTIF by region last quarter”). In short, dimensions turn raw data fields into <b>business-intuitive handles</b> for exploring performance and driving insight.

</p>

<h2 class="h4 mb-lg-4 pt-3 pt-md-4 pt-xl-5">measures</h2>

<!--
<p class="fs-lg">
These are the final calculations. The logic is now simple:
</p>

<pre class="line-numbers mt-5 mb-5">
<code class="lang-sql">otif_rate: AVG(otif_flag)
on_time_rate: AVG(on_time)
in_full_rate: AVG(in_full)</code>
</pre>
-->

<p class="fs-lg">
In the <code>measures</code> section of this Databricks metric view, each entry defines a quantitative KPI that the platform can automatically compute, aggregate, and visualize for business users—essentially translating raw operational data into trusted performance metrics. For example, <code>otif_rate</code> calculates the percentage of purchase orders that were delivered both <b>on time</b> and <b>in full</b>, serving as the core KPI for logistics reliability. Supporting metrics like <code>on_time_rate</code> and <code>in_full_rate</code> break that down further, showing punctuality and fulfillment quality separately. Meanwhile, <code>otif_count</code> and <code>po_count</code> give absolute counts of compliant shipments and unique purchase orders, and <code>shipment_rows</code> provides a baseline measure of total records available for analysis.
</p>

<p class="fs-lg">
This section formalizes logic that would otherwise live in ad hoc SQL or spreadsheet formulas. Each measure is not just a calculation but a <b>governed, reusable semantic definition</b> that’s enforced across AI/BI dashboards, Genie queries, and analytics layers. By centralizing these in the metric view YAML, Databricks ensures every tool and user—from engineers to executives—references the same logic for OTIF and related KPIs, dramatically improving consistency, data governance, and time-to-insight across the enterprise.
</p>




<h2 class="h2 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Querying Metric Views</h2>

<p class="fs-lg">
When querying a <code>metric view</code> in Databricks, think of it as querying a <b>business-ready semantic layer</b>, not a raw table. Each metric view already contains the necessary joins, calculations, and metadata to produce accurate, consistent KPIs—so analysts or AI/BI tools can simply <code>SELECT</code> dimensions (like region, carrier, or month) and measures (like <code>otif_rate</code> or <code>on_time_rate</code>) without rebuilding logic. 
</p>

<p class="fs-lg">
  In practice, this means you query it the same way as any SQL view, but the results come pre-governed and semantically enriched, making it ideal for dashboards, Genie prompts, and executive reporting.

</p>

<p class="fs-lg">
When querying <b>measures</b> from a Databricks metric view, you need to use an <b>aggregate function</b> — such as <code>SUM()</code>, <code>AVG()</code>, <code>COUNT()</code>, or similar — because measures are designed to be aggregated across the chosen dimensions. For example:
</p>

<pre class="line-numbers mt-5 mb-5">
<code class="language-sql">
SELECT
  DATE_TRUNC('month', date) AS month,
  AVG(otif_rate) AS avg_otif
FROM big_cloud_dealz_development.gold.metric_view_otif
GROUP BY month;
</code>
</pre>

<p class="fs-lg">
If you want to just use the default measure logic with no aggregation function, then <b>measures must be wrapped in <a href="https://docs.databricks.com/aws/en/sql/language-manual/functions/measure" target="_blank"><code>MEASURE()</code> aggregate functions</a></b> when queried, since they represent numeric KPIs summarized over groups of dimension values.
</p>






<!--

<p class="fs-lg todo_edit">

Additionally, in Databricks, when working with <b>metric views</b>, the <code>MEASURE()</code> function is used to <b>reference defined measures</b> directly by name, instead of re-typing their SQL expressions. This makes queries simpler, more readable, and consistent with the semantic definitions stored in the metric view YAML.
</p>

<p class="fs-lg todo_edit">
For example, instead of writing out the full <code>AVG(otif_flag)</code> expression, you can write:
</p>

<pre class="line-numbers mt-5 mb-5">
<code class="language-sql">
SELECT
  date,
  MEASURE(otif_rate) AS otif_percentage,
  MEASURE(on_time_rate),
  MEASURE(in_full_rate)
FROM big_cloud_dealz_development.gold.metric_view_otif
GROUP BY date;
</code>
</pre>
-->
<!--
<p class="fs-lg">
The <code>MEASURE()</code> function tells Databricks to **resolve the measure’s expression** (defined in the YAML) and apply it correctly in the context of the query. It’s a way to query governed business metrics safely and consistently—ensuring everyone uses the same underlying logic for KPIs like OTIF, On-Time %, or In-Full %.
</p>
-->


            <div class="card bg-primary bg-opacity-10 border-0 overflow-hidden pt-1 pt-xl-2 px-lg-2 px-xl-4 mb-5 mt-5">
              <div class="card-body position-relative z-2 pb-0">
                <h3 class="h4 card-title text-primary">How the MEASURE Function Differs from AVG() and SUM() in Databricks SQL</h3>

                <p class="pb-sm3 pb-md-4 mb-2">

When you write <code>SUM(column)</code> or <code>AVG(column)</code> in a conventional SQL query, you are explicitly telling the query engine how to aggregate a column — either by summing or averaging all values. You must decide what metric to calculate and include the correct <code>GROUP BY</code> clause if you’re slicing by dimensions. These functions operate directly on the data and require you to define the aggregation logic manually each time you query.
                </p>
                <p class="pb-sm3 pb-md-4 mb-2">

By contrast, in a Databricks <strong>metric view</strong>, the <code>MEASURE()</code> function is used to reference pre-defined business metrics without redefining their aggregation logic. Each measure is already defined in the YAML configuration with its own expression (for example, <code>AVG(otif_flag)</code> or <code>SUM(otif_flag)</code>). When you query the metric view, calling <code>MEASURE(otif_rate)</code> tells Databricks to automatically apply that governed definition. This means you’re consuming a standardized KPI rather than recreating it, ensuring consistency across dashboards, BI tools, and Genie queries.


                </p>

                <p class="pb-sm3 pb-md-4 mb-2">

This abstraction allows teams to separate <em>metric definition</em> from <em>metric consumption</em>. Analysts and AI systems can safely use <code>MEASURE()</code> to retrieve accurate, governed results without worrying about how the measure is calculated internally — dramatically reducing risk, duplication, and inconsistency across the analytics stack.

                </p>



<pre class="line-numbers mt-5 mb-5">
<code class="lang-sql">
-- Traditional SQL with explicit aggregation
SELECT
  DATE_TRUNC('month', date) AS month,
  AVG(otif_flag) AS otif_rate
FROM big_cloud_dealz_development.gold.metric_view_otif
GROUP BY month;

-- Databricks metric view query using MEASURE()
SELECT
  DATE_TRUNC('month', date) AS month,
  MEASURE(otif_rate) AS otif_percentage
FROM big_cloud_dealz_development.gold.metric_view_otif
GROUP BY month;
</code>
</pre>



              </div>
            </div>


<p class="fs-lg">
Ok, with all that explanation out of the way, let's get down to some example use cases of this handy OTIF metric view.
</p>











<h2 class="h3 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Example 1: Monthly OTIF Trend by Carrier</h2>

<p class="fs-lg">
Business Question: "Which carriers are consistently meeting their delivery promises?"
</p>

<pre class="line-numbers mt-5 mb-5">
<code class="language-sql">SELECT
  month,
  carrier_name,
  MEASURE(otif_rate) AS otif_rate,
  MEASURE(on_time_rate) AS on_time_rate,
  MEASURE(in_full_rate) AS in_full_rate
FROM big_cloud_dealz_development.gold.metric_view_otif
GROUP BY month, carrier_name
ORDER BY month ASC, otif_rate DESC;</code>
</pre>

<p class="fs-lg">
Why it's simple: The analyst just listed the dimensions and measures they wanted. The Metric View automatically generates the complex SQL to join all tables, calculate all three flags, and aggregate the results.
</p>

<h2 class="h3 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Example 2: Regional OTIF Comparison by Transport Mode</h2>

<p class="fs-lg">
Business Question: "How do our different transportation modes perform across our destination regions?"
</p>

<pre class="line-numbers mt-5 mb-5">
<code class="lang-sql">SELECT
  to_region,
  mode,
  MEASURE(otif_rate) AS otif_rate,
  MEASURE(shipment_rows) AS shipments
FROM big_cloud_dealz_development.gold.metric_view_otif
WHERE date &gt;= DATE '2025-01-01'
GROUP BY to_region, mode
ORDER BY otif_rate DESC;</code>
</pre>

<p class="fs-lg">
Why it's simple: The user is combining dimensions from two different joined tables (<code>dim_locations</code> and <code>dim_carriers</code>), and the Metric View handles these "fan-out" joins automatically.
</p>

<h2 class="h3 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Example 3: Daily OTIF Diagnostics</h2>

<p class="fs-lg">
Business Question: "Which destination regions had the worst OTIF performance last month?"
</p>

<pre class="line-numbers mt-5 mb-5">
<code class="lang-sql">-- Find the 50 worst-performing region-days last month
SELECT
  date,
  to_region,
  MEASURE(otif_rate),
  MEASURE(otif_count)
FROM big_cloud_dealz_development.gold.metric_view_otif
WHERE date BETWEEN DATE '2025-09-01' AND DATE '2025-09-30'
GROUP BY date, to_region
ORDER BY MEASURE(otif_rate) ASC
LIMIT 50;</code>
</pre>

<p class="fs-lg">
Why it's simple: This ad-hoc query is easy to write. The user can filter, group, and order by any combination of metrics without needing to know anything about the underlying tables or logic.
</p>


<h2 class="h2 mb-lg-4 pt-3 pt-md-4 pt-xl-5">Summary</h2>

<p class="fs-lg">

  In this article I showed how to build metric views for our semantic layer to power retail logistics knowledge work.

</p>

<p class="fs-lg">

  In the next article in this series we'll show how to start putting these information building blocks to work by <a href="next_generation_retail_logistics_analytics_with_databricks_ai_bi_dashboards.html" target="_blank">integrating them into AI / BI Dashboards</a> for management in a retail logistics division.

</p>




          </div>
        </div>
      </section>



      <section class="container pt-5 mt-md-2 mt-lg-3 mt-xl-4">


            
            <div class="d-flex flex-wrap pb-5 pt-3 pt-md-4 pt-xl-5 mt-xl-n2 pl-3">
              <h3 class="h3 py-1 mb-0 me-4">Next in Series</h3>
            </div>



                  <div class="card overflow-hidden mb-4">
                    <div class="row g-0">
                      <div class="col-sm-4 bg-repeat-0 bg-size-cover" style="background-image: url(../assets/img/databricks_retail_dashboard_header_0.jpg); min-height: 14rem;"></div>
                      <div class="col-sm-8">
                        <div class="card-body">
                          <h4 class="card-title">Next-Generation Retail Logistics Analytics with Databricks AI / BI Dashboards</h4>
                          <p class="card-text">By surfacing key performance indicators like On-Time In-Full (OTIF) and Stockout Exposure through dynamic visualizations and natural-language insights, the dashboard transforms complex warehouse, carrier, and inventory data into actionable intelligence for the COO, logistics leads, and merchandising teams alike.</p>
                          
                <a class="btn btn-lg btn-link px-0" href="next_generation_retail_logistics_analytics_with_databricks_ai_bi_dashboards.html">
                  Read next article in series
                  <i class="ai-arrow-right ms-2"></i>
                </a>

                        </div>
                      </div>
                    </div>
                  </div>

      </section>
   




    </main>

    

  <footer class="footer py-5 bg-dark" data-bs-theme="dark">
      <div class="container pt-md-2 pt-lg-3 pt-xl-4">
        <div class="row pb-5 pt-sm-2 mb-lg-2">
          <div class="col-md-4 col-lg-3 pb-2 pb-md-0 mb-4 mb-md-0">


            <a class="navbar-brand pe-sm-3" href="/index.html">
              <span class="text-primary flex-shrink-0 me-2">
                <svg width="35" height="32" viewBox="0 0 36 33" xmlns="http://www.w3.org/2000/svg">

                  <g transform="matrix(0.004459, 0, 0, -0.00433, -8154.369629, -2022.807495)" fill="#000000" stroke="none" style="transform-origin: 8189.37px 2055.78px;">
                    <path d="M340 9410 l0 -260 1348 0 c807 0 1370 -4 1403 -9 30 -6 101 -15 159
                  -21 177 -19 447 -88 605 -155 242 -103 389 -186 553 -310 124 -94 287 -257
                  390 -390 26 -34 100 -148 140 -215 214 -362 327 -901 282 -1345 -11 -115 -47
                  -341 -58 -362 -5 -10 -14 -45 -21 -78 -7 -33 -16 -64 -20 -70 -4 -5 -13 -30
                  -20 -55 -7 -25 -19 -58 -26 -75 -70 -160 -92 -205 -132 -277 -45 -80 -161
                  -257 -189 -288 -8 -8 -33 -37 -56 -65 -60 -71 -200 -208 -277 -270 -88 -70
                  -241 -175 -258 -175 -7 0 -13 -3 -13 -8 0 -11 -304 -162 -326 -162 -3 0 -20
                  -7 -37 -14 -45 -21 -210 -74 -254 -82 -21 -4 -45 -10 -55 -15 -9 -5 -72 -18
                  -140 -30 -67 -12 -145 -26 -173 -31 -29 -6 -359 -12 -782 -15 l-733 -4 0
                  -1175 0 -1174 3270 0 3270 0 0 3695 0 3695 -3925 0 -3925 0 0 -260z" style="fill: rgb(255, 149, 0);"></path>
                    <path d="M1650 6884 l0 -1096 648 4 647 4 120 28 c66 16 125 32 130 36 6 4 28
                  13 50 20 53 17 129 56 179 92 23 16 52 36 66 46 86 60 201 201 261 322 84 168
                  109 281 116 525 7 251 -18 402 -97 580 -56 126 -184 280 -295 355 -27 18 -62
                  42 -77 52 -15 10 -29 18 -32 18 -3 0 -30 11 -60 25 -30 14 -61 25 -68 25 -7 1
                  -31 8 -53 16 -101 37 -228 44 -892 44 l-643 0 0 -1096z" style="fill: rgb(255, 149, 0);"></path>
                  </g>

                </svg>
              </span>
              <span class="text-light">
              Patterson Consulting
              </span>
            </a>    

            <p class="fs-sm pb-2 pb-md-3 mb-3 text-light">Delivering data pipelines, analytics, and large language model applications.</p>
            <div class="d-flex gap-3">
              <a class="btn btn-icon btn-sm btn-secondary btn-linkedin rounded-circle" href="https://www.linkedin.com/company/patterson-consulting-tn/" aria-label="LinkedIn">
                <i class="ai-linkedin"></i>
              </a>
            </div>
          </div>
          <div class="col-md-8 col-lg-7 col-xl-6 offset-lg-2 offset-xl-3">
            <div class="row row-cols-1 row-cols-sm-3">
              <div class="col mb-4 mb-md-0">
              </div>
              <div class="col mb-4 mb-md-0">

              </div>
              <div class="col mb-4 mb-md-0">
                <h4 class="h6 fw-bold pb-lg-1">Company</h4>
                <ul class="nav flex-column">
                  <li><a class="nav-link fw-normal py-1 px-0" href="/contact_us.html">Contact Us</a></li>
                  <li><a class="nav-link fw-normal py-1 px-0" href="/blog/blog_index.html">Blog</a></li>
                  <li><a class="nav-link fw-normal py-1 px-0" href="/index.html#case_studies">Case Studies</a></li>
                  <li><a class="nav-link fw-normal py-1 px-0" href="/publications.html">eBooks</a></li>
                  <li><a class="nav-link fw-normal py-1 px-0" href="https://www.youtube.com/channel/UCmaki2Xq1AeFL8XbWGIWyQg">Videos</a></li>
                  <li><a class="nav-link fw-normal py-1 px-0" href="/about.html">About</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <p class="nav fs-sm mb-0">
          <span class="text-body-secondary">© All rights reserved. Made by</span>
          <a class="nav-link fw-normal p-0 ms-1" href="https://www.pattersonconsultingtn.com/" target="_blank" rel="noopener">Patterson Consulting</a>
        </p>
      </div>
    </footer>    


    <a class="btn-scroll-top" href="#top" data-scroll aria-label="Scroll back to top">
      <svg viewBox="0 0 40 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <circle cx="20" cy="20" r="19" fill="none" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10"></circle>
      </svg>
      <i class="ai-arrow-up"></i>
    </a>

  <script src="../assets/js/prism.js"></script>



    <script src="../assets/vendor/jarallax/dist/jarallax.min.js"></script>
    <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
    


    <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="../assets/vendor/lightgallery/lightgallery.min.js"></script>


    <script src="../assets/vendor/lightgallery/plugins/fullscreen/lg-fullscreen.min.js"></script>
    <script src="../assets/vendor/lightgallery/plugins/zoom/lg-zoom.min.js"></script>
    <script src="../assets/vendor/lightgallery/plugins/video/lg-video.min.js"></script>
    <script src="../assets/vendor/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script>



    <script src="../assets/js/theme.min.js"></script>
  </body>
</html>

