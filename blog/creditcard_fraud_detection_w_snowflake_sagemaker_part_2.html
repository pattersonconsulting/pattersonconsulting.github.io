
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
	<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-119541534-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-119541534-1');
</script>
		
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Detecting Credit Card Fraud with Snowflake, Snowpark, and SageMaker Studio - Part 2 of 3: Scalable Feature Engineering with Snowpark</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="description" content="In this blog post series on ....." />
	<meta name="keywords" content="snowflake, predictive maintenance, exploratory data analysis, machine learning, data science, snowpark" />
	<meta name="author" content="Patterson Consulting" />

  	<!-- Facebook and Twitter integration -->
	<meta property="og:title" content="Detecting Credit Card Fraud with Snowflake, Snowpark, and SageMaker Studio - Part 2 of 3: Scalable Feature Engineering with Snowpark"/>
	<meta property="og:image" content="http://www.pattersonconsultingtn.com/blog/images/meta_og_images/pct_apm_p2_og_card.png"/>
	<meta property="og:url" content="http://www.pattersonconsultingtn.com/blog/predictive_maintenance_w_snowflake_ml_part_2_ingest.html"/>
	<meta property="og:site_name" content=""/>
	<meta property="og:description" content="In this blog post series o...."/>
	

	<meta name="twitter:title" content="Detecting Credit Card Fraud with Snowflake, Snowpark, and SageMaker Studio - Part 2 of 3: Scalable Feature Engineering with Snowpark" />
	<meta data-rh="true" property="twitter:description" content="In this blog post series ...."/>

	<meta name="twitter:image" content="http://www.pattersonconsultingtn.com/blog/images/meta_og_images/pct_apm_p2_og_card.png" />
	<meta name="twitter:url" content="http://www.pattersonconsultingtn.com/blog/predictive_maintenance_w_snowflake_ml_part_2_ingest.html" />
	<meta name="twitter:card" content="summary_large_image" />

	<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
	<!-- <link rel="shortcut icon" href="favicon.ico"> -->
	
	<link rel="stylesheet" href="../css/animate.css">
	<link rel="stylesheet" href="../css/bootstrap.css">
	<link rel="stylesheet" href="../css/icomoon.css">

	<link rel="stylesheet" href="../css/owl.carousel.min.css">
	<link rel="stylesheet" href="../css/owl.theme.default.min.css">

	<link rel="stylesheet" href="../css/style.css">

	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

	<link rel="shortcut icon" href="http://www.pattersonconsultingtn.com/pct.ico" type="image/x-icon" />

	<style>
		a { 
			color: #FF0000; 
			text-decoration: underline;
		}

		span.quote_to_rewrite {
			color: #FF0000;
			font-style: italic;
		}

table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}

h2 {
	color: #555555;
}

pre {
    background: #f4f4f4;
    border: 1px solid #ddd;
    border-left: 3px solid #f36d33;
    color: #666;
    page-break-inside: avoid;
    font-family: monospace;
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 1.6em;
    max-width: 100%;
    overflow: auto;
    padding: 1em 1.5em;
    display: block;
    word-wrap: break-word;
}

.news_item_row {
	border: 0px solid #999999; 
	padding: 0px; 
	padding-top: 20px; 
	padding-bottom: 24px; 
	margin: 0px; 
	margin-bottom: 6px; 
	background-color: #ffffff;

}

.news_item_label {
	border: 1px solid #cccccc; 
	border-bottom: 0px; 
	width: 50%; 
	padding: 12px; 
	padding-top: 18px; 
	margin: 0px; 
	margin-left: 0px; 
	background-color: #dddddd;
}


.news_item_body {
	border: 2px solid #cccccc; 
	padding: 12px; 
	padding-top: 18px; 
	margin: 20px; 
	margin-left: 0px; 
	margin-top: 0px; 
	background-color: #ffffff;

}

blockquote.rewrite {

	color:  red;
}

</style>	

	<script src="../js/modernizr-2.6.2.min.js"></script>
	<!--[if lt IE 9]>
	<script src="js/respond.min.js"></script>
	<![endif]-->

	</head>
	<body class="boxed">
	<!-- Loader -->
	<div class="fh5co-loader"></div>

	<div id="wrap">

	<div id="fh5co-page">
		<header id="fh5co-header" role="banner">
			<div class="container">
				<a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle dark"><i></i></a>
				<div id="fh5co-logo"><a href="index.html"><img src="../images/website_header_top_march2018_v0.png" ></a></div>
				<nav id="fh5co-main-nav" role="navigation">
		          <ul>
		            
		            <li class="has-sub">
		              <div class="drop-down-menu">
		                <a href="#">Services</a>
		                <div class="dropdown-menu-wrap">
		                  <ul>
		                    
		                    <li><a href="../offerings/snowflake_services.html">Snowflake</a></li>
		                    <li><a href="../offerings/data_engineering.html">Data Engineering</a></li>
		                    <li><a href="../offerings/data_science.html">Data Science</a></li>

		                    <li><a href="../offerings/cloud_operations.html">Cloud Operations and Engineering</a></li>
		                    
		                    <li><a href="../offerings/managed_kubeflow.html">Managed Kubeflow</a></li>

		                    <li><a href="../offerings/managed_kafka.html">Managed Kafka</a></li>

		                    <li><a href="../offerings/research_partnerships.html">Research Partnerships</a></li>
		                    
		                  </ul>
		                </div>
		              </div>
		            </li>
		            
		            <li><a href="../partners.html">Partners</a></li>

		            <li><a href="../blog/blog_index.html">Blog</a></li>
		          
		            <li class="cta"><a href="../contact.html">Contact</a></li>
		          </ul>
		        </nav>
			</div>
		</header>
		<!-- Header -->

		
		<div id="fh5co-intro" class="fh5co-section">
			<div class="container">


		
				<div class="row row-bottom-padded-sm">
					<div class="col-md-12" id="fh5co-content">
						<h1>Detecting Credit Card Fraud with Snowflake, Snowpark, and SageMaker Studio</h1>
						<p>
							<h3>Part 2 of 3: Scalable Feature Engineering with Snowpark</h3>


						</p>
						<p>
							Author: Josh Patterson<br/>
							Date: zzzzzzz xxth, 2022
						</p>
						

						<p>
							Other entries in this series:

							<ul>

								<li>Part 1: <a href="creditcard_fraud_detection_w_snowflake_sagemaker_part_1.html">Loading the Credit Card Transaction Data Into Snowflake</a></li>
								<li>Part 2: <a href="creditcard_fraud_detection_w_snowflake_sagemaker_part_2.html">Scalable Feature Engineering with Snowpark</a></li>
								<li>Part 3: <a href="creditcard_fraud_detection_w_snowflake_sagemaker_part_3.html">Grid Search Model Construction with Sagemaker Studio Lab</a></li>
							</ul>


						</p>

						For more use cases like these, check out our <a href="http://www.pattersonconsultingtn.com/use_case_repository/finserv_vertical.html">Financial Services vertical</a> in our <a href="http://www.pattersonconsultingtn.com/use_case_repository/intro.html">Use Case Repository</a>.




					</div>

				</div>




				<!-- Section 1 of 5: Intro, PM in Cloud -->

				<div class="row row-bottom-padded-sm">
					<div class="col-md-12" id="fh5co-content">

						<h1>Introduction</h1>

						<p>
							In our last article ....

						</p>

						<p>
							Before we get to Sagemaker Studio Lab, we need to do some scalable feature engineering ...

						</p>


					</div>
				</div>

				<!-- Section 1 of 5: Intro, PM in Cloud -->




				<!-- Section 2 of 5: UCI Dataset -->

				<div class="row row-bottom-padded-sm">
					<div class="col-md-12" id="fh5co-content">


						<h1>Credit Card Transaction Data in Snowflake</h1>

						<p>
							what data did we start with?
							

						</p>

						<p>
							where did the data come from?

							[ give the original project some pub ]
							

						</p>





					</div>

				</div>


				<!-- Section 2 of 5: UCI Dataset -->






				<!-- Section 3 of 5: Snowflake bulk load -->

				<div class="row row-bottom-padded-sm">
					<div class="col-md-12" id="fh5co-content">
						


						<h1>Scalable Feature Engineering with Snowpark</h1>

						<img src="./images/snowflake_logo_wide_sept_2021.png" width="400px;" style="float: right;"/>


						<p>
							[ Talk about last project where we used snowpark to do scalable model inference ]

						</p>

<blockquote class="rewrite">"Feature engineering is the process of using domain knowledge to extract features (characteristics, properties, attributes) from raw data. Simply put, we want to create new features (columns) for our dataset using the data we already have in it."</blockquote>

<blockquote class="rewrite">
There is unfortunately no standard procedure to deal with non-numerical or categorical features. The topic is known in the machine learning literature as feature engineering or feature transformation. In essence, the goal of feature engineering is to design new features that are assumed to be relevant for a predictive problem. The design of these features is usually problem-dependent, and involves domain knowledge.
</blockquote>

						<p>
							[ Talk about how we need to do feature engineering with input size is large ]

						</p>						


						<p>

							[ Explain what we plan on doing here --- wrt to building features ]


						</p>
						



						<p>
							With all of this in mind, let's get started working with Snowflake.
							

						</p>





				<div class="row row-bottom-padded-sm" style=" border: 1px solid #cccccc; border-radius: 10px; padding: 8px; padding-top: 8px; background-color: #FF5126; color: #ffffff; font-size: 14px; font-weight: normal; margin-bottom: 30px; ">
					
					<div class="col-md-3" id="fh5co-content" style="">

						<h3 style="color: #ffffff;">Looking for Snowflake Help?</h3>

					</div>
					<div class="col-md-9" id="fh5co-content" style="margin-bottom: 0px;">


						<div style="background-color: ; padding: 1px; margin-bottom: 0px;">
						<p style="margin: 0px;">
							Our team can help -- we help companies with <a href="../offerings/snowflake_services.html" style="color: #EEEEEE;">Snowflake platform operations, analytics, and machine learning</a>.

						</p>
						</div>
					</div>


				</div>		




						<h2>Feature Engineering Workflow Overview</h2>


						<p>
							[ what features do we want to create? ]

						</p>

						<p>

							Sanity Check: 1,754,155 records --- keep rechecking after each transform


						</p>

						<p>

							Talk up the original pipeline:

							https://fraud-detection-handbook.github.io/fraud-detection-handbook/Chapter_3_GettingStarted/BaselineModeling.html


						</p>

						<p>

<blockquote class="rewrite">
"My colleague Mats Stellwall made an incredible work documenting in his blog post Feature Engineering with Snowflake how to use Snowpark Scala. That was based on the book Reproducible Machine Learning for Credit Card Fraud Detection that explains some feature engineering techniques to enrich your data set and provide better results in your ML algorithm.
</blockquote>
							[ Give the feature engineering of the snowflake guy some pub ]

						</p>

<blockquote class="rewrite">The dataset has very few features, as illustrated in the picture below. Date and time for the transaction, id of the customer, what terminal was used and amount. It also has an added feature, or rather a label, that flags if the transaction was fraudulent or not, and that would be our target when training a machine learning model at a later stage.

	<br/>
	My data have three types of features; identifiers, timestamp and amount.

</blockquote>

<blockquote class="rewrite">
Machine learning algorithms typically require numerical and ordered features. Numerical means that the type of the variable must be an integer or a real number. Ordered means that the order of the values of a variable is meaningful.
</blockquote>

<blockquote class="rewrite">
	Identifiers do not provide any value, primary because they usually has a high cardinality, meaning a high number of unique values, and therefore they would only provide value if a specific customer or terminal is responsible for the majority of the frauds.
	</blockquote>

<blockquote class="rewrite">
In this dataset, the only numerical and ordered features are the transaction amount and the fraud label. The date is a Panda timestamp, and therefore not numerical. The identifiers for the transactions, customers, and terminals are numerical but not ordered: it would not make sense to assume for example that the terminal with ID 3548 is ‘bigger’ or ‘larger’ than the terminal with ID 1983. Rather, these identifiers represent distinct ‘entities’, which are referred to as categorical features.
</blockquote>


<blockquote class="rewrite">
	Date and time is another example of features that does not work well with most machine learning algorithms. This is because the value itself has not so much meaning without domain knowledge, for example, 2019–04–01 and 2019–04–08 is just two different values. However, both you and I can probably see that they are for the year 2019 and the month of April and if using a calendar we can also see that they both are Mondays. This is because we know that they are dates and have the knowledge of how to read those, a machine learning algorithm does not have this knowledge so we need to provide that information in another way.
</blockquote>





						<p>

							3 Types of feature transformations that are known to be relevant for payment card fraud detection

							<ul>

								<li>Binary encoding or 1-hot encoding</li>
								<li>RFM (Recency, Frequency, Monetary Value)</li>
								<li>Frequency Encoding or Risk encoding</li>

							</ul>


						</p>

						<h4>Creating Temporal Features (Date/Time) Features</h4>
							<p>
<blockquote class="rewrite">
The first type of transformation involves the date/time variable, and consists in creating binary features that characterize potentially relevant periods. We will create two such features. The first one will characterize whether a transaction occurs during a weekday or during the weekend. The second will characterize whether a transaction occurs during the day or the night. These features can be useful since it has been observed in real-world datasets that fraudulent patterns differ between weekdays and weekends, and between the day and night.
</blockquote>


							</p>



						<h4>Creating Customer Spending Behavior Features</h4>
							<p>
<blockquote class="rewrite">
The second type of transformation involves the customer ID and consists in creating features that characterize the customer spending behaviors. We will follow the RFM (Recency, Frequency, Monetary value) framework proposed in [VVBC+15], and keep track of the average spending amount and number of transactions for each customer and for three window sizes. This will lead to the creation of six new features.
</blockquote>


							</p>






						<h4>Creating Terminal Risk Features</h4>
							<p>
<blockquote class="rewrite">
The third type of transformation involves the terminal ID and consists in creating new features that characterize the ‘risk’ associated with the terminal. The risk will be defined as the average number of frauds that were observed on the terminal for three window sizes. This will lead to the creation of three new features.
</blockquote>


							</p>

							<p>
								Note: we're not going to convert these features in Snowflake, but leave this part to be converted inside the AWS Sagemaker Studio Lab notebook to compare execution speeds


							</p>





						<h3>Table of Features to Create</h3>



						<p>

							The table below shows the details on the features


						</p>


<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Original feature name</p></th>
<th class="head"><p>Original feature type</p></th>
<th class="head"><p>Transformation</p></th>
<th class="head"><p>Number of new features</p></th>
<th class="head"><p>New feature(s) type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>TX_DATE_TIME</p></td>
<td><p>Panda timestamp</p></td>
<td><p>0 if transaction during a weekday, 1 if transaction during a weekend. The new feature is called TX_DURING_WEEKEND.</p></td>
<td><p>1</p></td>
<td><p>Integer (0/1)</p></td>
</tr>
<tr class="row-odd"><td><p>TX_DATE_TIME</p></td>
<td><p>Panda timestamp</p></td>
<td><p>0 if transaction between 6am and 0pm, 1 if transaction between 0pm and 6am. The new feature is called TX_DURING_NIGHT.</p></td>
<td><p>1</p></td>
<td><p>Integer (0/1)</p></td>
</tr>
<tr class="row-even"><td><p>CUSTOMER_ID</p></td>
<td><p>Categorical variable</p></td>
<td><p>Number of transactions by the customer in the last n day(s), for n in {1,7,30}. The new features are called CUSTOMER_ID_NB_TX_nDAY_WINDOW.</p></td>
<td><p>3</p></td>
<td><p>Integer</p></td>
</tr>
<tr class="row-odd"><td><p>CUSTOMER_ID</p></td>
<td><p>Categorical variable</p></td>
<td><p>Average spending amount in the last n day(s), for n in {1,7,30}. The new features are called CUSTOMER_ID_AVG_AMOUNT_nDAY_WINDOW.</p></td>
<td><p>3</p></td>
<td><p>Real</p></td>
</tr>
<tr class="row-even"><td><p>TERMINAL_ID</p></td>
<td><p>Categorical variable</p></td>
<td><p>Number of transactions on the terminal in the last n+d day(s), for n in {1,7,30} and d=7. The parameter d is called delay and will be discussed later in this notebook. The new features are called TERMINAL_ID_NB_TX_nDAY_WINDOW.</p></td>
<td><p>3</p></td>
<td><p>Integer</p></td>
</tr>
<tr class="row-odd"><td><p>TERMINAL_ID</p></td>
<td><p>Categorical variable</p></td>
<td><p>Average number of frauds on the terminal in the last n+d day(s), for n in {1,7,30} and d=7. The parameter d is called delay and will be discussed later in this notebook. The new features are called TERMINAL_ID_RISK_nDAY_WINDOW.</p></td>
<td><p>3</p></td>
<td><p>Real</p></td>
</tr>
</tbody>
</table>



						<p>

							[in-segue]

							Let's now jump into how to port the weekend and night features to Snowpark.


						</p>







					</div>

				</div>

				<!-- Section 3 of 5: Snowflake bulk load -->




				<!-- Section 4 of 5: Connecting Google Co-lab to Snowflake -->
				<div class="row row-bottom-padded-sm">
					<div class="col-md-12" id="fh5co-content">

						<h1>Running Snowpark Feature Engineering Pipelines</h1>

						<p>


						</p>


						<p>

							In this article we are going to port the feature creation of the following features to Snowpark:

							<ul>
								<li>Create weekend and night features</li>
								<li>Customer Transaction Features</li>
							</ul>

							We'll complete the last set of features ("Terminal Features") in python in part-3 of this series. Let's now jump into how to port the weekend and night features to Snowpark.


						</p>



						<h2>Create Scala Project to Connect to Snowflake and Run Snowpark Code</h2>

						<p>

							Check our last article on how to stand up Snowflake connector 


						</p>		

						<p>
							This github repo will give you a scala Snowpark pipeline to perform these feature engineering transformations ...

						</p>	


						<h2>Create Weekend and Night Features in Scala for Snowpark</h2>

						<p>



						</p>

						<p>
							

						</p>						


\



						<h2>Create Customer Transaction Features in Scala for Snowpark</h2>

						<p>


						</p>			

<blockquote class="rewrite">

What I want to do is to calculate the number of transactions and average amount on a day level, but I need to store it on a transaction level. The calculations is to be based on previous one, seven and thirty days and also including the transactions done so far during the current day of a transaction.
</blockquote>						


<blockquote class="rewrite">
Snowflake has window functions that allows operations on a group of rows and allows you to perform rolling operations, such as calculating a running total or a moving average, on a subset of the rows in the window.
</blockquote>



						<div style="width:900px; margin:0 auto;">

							<div class="w3-panel w3-leftbar w3-light-grey" style="padding: 16px; font-size: 12px; border: 1px solid #999999; width: 85%; text-align: left;">
								<img src="./images/crab_warn_230.png" style=" width: 80px; height: 80px; float: left; margin-right: 20px;" />

								<h4>Rolling Window Calculations in Snowflake</h4>
							  <p style="font-size: 14px; ">
							  <i>
							  	[ Snowflake does it differently than Pandas ... ]
							  	
[ How do the snowpark dataframe operations differ from the pandas operations? --- this is where we talk about Pandas rolling windows:

							https://pandas.pydata.org/docs/reference/api/pandas.core.window.rolling.Rolling.count.html ]

							  </i></p>
							  
							</div>	

						</div>

<blockquote class="rewrite">


    calculate the number of transactions and average amount on a day level, 
    but I need to store it on a transaction level. 
    The calculations is to be based on previous 
      one, seven and thirty days 
    and also including the transactions done so far during the current day of a transaction.

  divide work into multiple steps and that is something that is easy to do using a programming language and the Snowpark API.<br/><br/>

  (1.) Generate a dataframe with one row for each customer and day that is between the minimum and maximum date in our data.<br/>
  (2.) Calculate the number of transaction and amount by customer and day, adding zeros for those days the customer has no transactions.<br/>
  (3.) Using Snowflake window functions to calculate the number of transaction and average amount during previous one, seven and thirty days, excluding the current day.
  (4.) Join it with the transactions and also calculate the transactions and amount during the current day.<br/>
</blockquote>

						<h2>Save Created Features as New Table in Snowpark</h2>

						<p>


						</p>			
<pre>dfCustBehaviurFeat.write.mode(SaveMode.Overwrite).saveAsTable("CUSTOMER_CC_TRANSACTION_FEATURES")
</pre>


					</div>

				</div>

				<!-- Section 4 of 5: Connecting Google Co-lab to Snowflake -->




				<!-- Section 5 of 5: Next Steps: EDA -->
				<div class="row row-bottom-padded-sm">
					<div class="col-md-12" id="fh5co-content">
						
						<h1>Next Steps: Build Transaction Fraud Detection Models</h1>


						<p>


							In this post in our series we learned how ....

						</p>
						<p>
							....

						</p>

					</div>

				</div>
				<!-- Section 5 of 5: Next Steps: EDA -->







				<div class="row row-bottom-padded-sm" style=" border: 1px solid #cccccc; border-radius: 10px; padding: 8px; padding-top: 8px; background-color: #FF5126; color: #ffffff; font-size: 14px; font-weight: normal; margin-bottom: 30px; ">
					
					<div class="col-md-3" id="fh5co-content" style="">

						<h3 style="color: #ffffff;">Looking for Snowflake Help?</h3>

					</div>
					<div class="col-md-9" id="fh5co-content" style="margin-bottom: 0px;">


						<div style="background-color: ; padding: 1px; margin-bottom: 0px;">
						<p style="margin: 0px;">
							Our team can help -- we help companies with <a href="../offerings/snowflake_services.html" style="color: #EEEEEE;">Snowflake platform operations, analytics, and machine learning</a>.

						</p>
						</div>
					</div>


				</div>		




			</div>
		</div>



		<footer id="fh5co-footer" role="contentinfo">
			<div class="container">
				<div class="row row-bottom-padded-sm">
					<div class="col-md-4 col-sm-12">
					</div>
					<div class="col-md-3 col-md-push-1 col-sm-12 col-sm-push-0">
						<div class="fh5co-footer-widget">
				

						</div>
					</div>
					<div class="col-md-3 col-md-push-2 col-sm-12 col-sm-push-0">
						
						<div class="fh5co-footer-widget">
							<h3>Follow us</h3>
							<ul class="fh5co-social">
								<li class="twitter"><a href="https://twitter.com/PattersonCnsltg"><i class="icon-twitter"></i></a></li>
								<li class="linkedin"><a href="https://www.linkedin.com/company/patterson-consulting-tn"><i class="icon-linkedin"></i></a></li>
								<li class="message"><a href="mailto:josh@pattersonconsultingtn.com"><i class="icon-mail"></i></a></li>
							</ul>
						</div>
					</div>

				</div>

			</div>
		</footer>


	</div>
	</div>

	<div class="gototop js-top">
		<a href="#" class="js-gotop"><i class="icon-chevron-down"></i></a>
	</div>
	
	<script src="../js/jquery.min.js"></script>
	<script src="../js/jquery.easing.1.3.js"></script>
	<script src="../js/bootstrap.min.js"></script>
	<script src="../js/owl.carousel.min.js"></script>
	<script src="../js/main.js"></script>

	</body>
</html>					
